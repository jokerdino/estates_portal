{% extends "base_generic.html" %}
{% load django_bootstrap5 %}

{% block content %}

<div class="container">
    <h1 class="title">
        {{ title }}
    </h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <fieldset class="border p-3 mb-4">
            <legend class="float-none w-auto">Lease details</legend>
            {% bootstrap_form lease_form layout="horizontal" %}
        </fieldset>
        <fieldset class="border p-3 mb-4">
            <legend class="float-none w-auto">Employee details</legend>
            {% bootstrap_form primary_employee_form layout="horizontal" %}
        </fieldset>

        <fieldset class="border p-3 mb-4" id="joint-employee-section">
            <legend class="float-none w-auto">Joint employee details</legend>
            {% bootstrap_form joint_employee_form layout="horizontal" %}
        </fieldset>

        <fieldset class="border p-3 mb-4" id="landlord-section">
            <legend class="float-none w-auto">Landlord details</legend>
            {% bootstrap_form landlord_form layout="horizontal" %}
        </fieldset>

        <div class="text-center">
            {% bootstrap_button button_type="submit" content="Submit" %}
            {% bootstrap_button button_type="reset" content="Cancel" %}
        </div>
    </form>
</div>

<script>
    const leaseTypeSelect = document.getElementById("id_type_of_lease");
    const jointSection = document.getElementById("joint-employee-section");

    // function toggleJoint() {
    //     if (leaseTypeSelect.value === "joint") {
    //         jointSection.style.display = "block";
    //     } else {
    //         jointSection.style.display = "none";
    //     }
    // }
    function toggleJoint() {
        if (leaseTypeSelect.value === "joint") {
            jointSection.style.display = "block";
            jointSection.querySelectorAll("input, select").forEach(el => el.disabled = false);
        } else {
            jointSection.style.display = "none";
            jointSection.querySelectorAll("input, select").forEach(el => el.disabled = true);
        }
    }


    toggleJoint();
    leaseTypeSelect.addEventListener("change", toggleJoint);
</script>
<script>
    const getEmployeeUrl = "{% url 'get_employee' %}";
    function setupEmployeeAutoFill(prefix) {
        const empNumberInput = document.getElementById(`id_${prefix}-employee_number`);

        if (!empNumberInput) return;

        empNumberInput.addEventListener("blur", function () {
            const empNumber = empNumberInput.value.trim();
            if (!empNumber) return;

            fetch(`${getEmployeeUrl}?employee_number=${encodeURIComponent(empNumber)}`)
                .then(response => {
                    if (!response.ok) throw new Error("Not found");
                    return response.json();
                })
                .then(data => {
                    // Fill other fields
                    document.getElementById(`id_${prefix}-employee_name`).value = data.employee_name || "";
                    document.getElementById(`id_${prefix}-employee_designation`).value = data.employee_designation || "";
                    document.getElementById(`id_${prefix}-office_code`).value = data.office_code || "";
                    document.getElementById(`id_${prefix}-department`).value = data.department || "";
                    document.getElementById(`id_${prefix}-office_name`).value = data.office_name || "";
                    document.getElementById(`id_${prefix}-housing_loan`).value = data.housing_loan || "";
                })
                .catch(err => {
                    console.log("Employee not found, new entry.");
                    // Optionally clear fields
                });
        });
    }

    // Call for both primary and joint employee forms
    setupEmployeeAutoFill("primary");
    setupEmployeeAutoFill("joint");
</script>

{% endblock content %}
